datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.png"
  theme    = "dark"
}

//
// MODELS
//

/// 창고
model Warehouse {
  id            Int      @id @default(autoincrement())   // 내부 DB PK
  warehouse_id  String   @unique                         // ERP용 식별자 (예: "WH-0001")
  name          String
  location      String
  isused        UseState @default(USED)
  created_at    DateTime @default(now())

  inventory Inventory[]
  vendorOrders VendorOrder[]
  lotTraces     LotTrace[]    
}

/// 재고
model Inventory {
  id            Int       @id @default(autoincrement())
  inventory_id  String    @unique                        // ERP용 ID (예: "INV-0001")
  warehouse_id  Int
  item_id       Int
  lot_id        String    @unique
  quantity      Int
  safety_stock  Int
  store_date    DateTime
  expiry_date   DateTime
  status        InventoryStatus
  updated_at    DateTime @updatedAt

  warehouse Warehouse @relation(fields: [warehouse_id], references: [id])
  item      Item      @relation(fields: [item_id], references: [id])

  lotTraces     LotTrace[]

  @@unique([warehouse_id, item_id, expiry_date])
}

/// 품목
model Item {
  id          Int      @id @default(autoincrement())
  item_id     String   @unique                         // ERP용 (예: "IT-0001")
  category_id Int
  vendor_id   Int
  name        String
  unit_id     Int
  unit_price  Int
  isused      UseState
  expiry_date DateTime
  created_at  DateTime @default(now())

  inventory    Inventory[]
  orderRequest OrderRequest[]
  vendorOrders VendorOrder[]
  lotTraces    LotTrace[]

  category Category @relation(fields: [category_id], references: [id], onDelete: Cascade)
  vendor   Vendor   @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  unit     Unit     @relation(fields: [unit_id], references: [id], onDelete: Cascade)

}

/// 단위(Unit)
model Unit {
  id      Int      @id @default(autoincrement())
  unit_id String   @unique                         // ERP용 (예: "U-0001")
  code    String   @unique
  name    String
  isused  UseState @default(USED)

  items Item[]
}

/// 지점 발주
model OrderRequest {
  id          Int         @id @default(autoincrement())
  order_id    String      @unique                         // ERP용 (예: "OR-0001")
  branch_id   Int
  item_id     Int
  quantity    Int
  status      OrderStatus
  amount      Int         @default(0)
  created_at  DateTime    @default(now())


  branch   Branch    @relation(fields: [branch_id], references: [id])
  item     Item      @relation(fields: [item_id], references: [id])
  shipment Shipment?
}

/// 거래처 발주
model VendorOrder {
  id               Int      @id @default(autoincrement())   // DB PK
  vendor_order_id  String   @unique                         // ERP용 (예: "VO-0001")
  wh_id            Int
  vendor_id        Int
  item_id          Int
  quantity         Int
  received_quantity Int      @default(0) // 누적 입고 수량
  unit_price       Int       @default(0) //발주 당시 단가
  amount           Int       @default(0)  
  status           OrderStatus
  created_at       DateTime @default(now())

  //shipment   Shipment?  @relation(fields: [shipment_id], references: [id])
  vendor    Vendor    @relation(fields: [vendor_id], references: [id])
  item      Item      @relation(fields: [item_id], references: [id])
  warehouse Warehouse @relation(fields: [wh_id], references: [id])
}

/// 출하
model Shipment {
  id              Int            @id @default(autoincrement())
  shipment_id     String         @unique                        // ERP용
  order_id        Int            @unique
  shipped_date    DateTime
  delivery_status DeliveryStatus

  orderRequest OrderRequest @relation(fields: [order_id], references: [id])
  lotTraces    LotTrace[]
  delivery     Delivery?
}

/// LOT 추적
model LotTrace {
  id               Int      @id @default(autoincrement())
  lot_id           String   @unique                        // ERP용
  item_id          Int
  warehouse_id     Int
  inventory_id     Int
  manufacture_date DateTime
  expiry_date      DateTime
  received_date    DateTime @default(now())
  shipment_id      Int?
  action_type      LotActionType @default(INBOUND)

  item        Item          @relation(fields: [item_id], references: [id])
  warehouse   Warehouse     @relation(fields: [warehouse_id], references:[id])
  inventory   Inventory     @relation(fields: [inventory_id], references:[id])
  shipment    Shipment?     @relation(fields: [shipment_id], references: [id])

  @@index([item_id, warehouse_id])
  @@index([expiry_date])
}

/// 카테고리
model Category {
  id            Int           @id @default(autoincrement())
  category_id   String        @unique                        // ERP용
  group         CategoryGroup
  category_name String
  isused        UseState      @default(USED)
  created_at    DateTime      @default(now())

  items Item[]
}

/// 지점
model Branch {
  id             Int       @id @default(autoincrement())
  branch_id      String    @unique                        // ERP용
  name           String
  location       String
  detail_address String
  store_owner    String
  contact        String
  isused         UseState  @default(USED)
  created_at     DateTime  @default(now())

  orderRequest  OrderRequest[]
  sales         BranchSales[]
  hygieneChecks BranchHygiene[]
}

/// 지점 매출
model BranchSales {
  id         Int      @id @default(autoincrement())
  sales_id   String   @unique                        // ERP용
  branch_id  Int
  date       DateTime
  revenue    Decimal
  profit     Decimal

  branch Branch @relation(fields: [branch_id], references: [id])
}

/// 위생 점검
model BranchHygiene {
  id              Int      @id @default(autoincrement())
  hygiene_id      String   @unique                        // ERP용
  branch_id       Int
  grade           HygieneGrade
  inspector_name  String
  inspection_date DateTime

  branch Branch @relation(fields: [branch_id], references: [id])
}

/// 거래처
model Vendor {
  id        Int      @id @default(autoincrement())
  vendor_id String   @unique                     // ERP용
  name      String
  manager   String
  contact   String
  address   String
  identification_number String
  isused    UseState

  items        Item[] 
  vendorOrders VendorOrder[]
  payments     VendorPayment[]
}

/// 거래처 결제
model VendorPayment {
  id           Int           @id @default(autoincrement())
  payment_id   String        @unique                        // ERP용
  vendor_id    Int
  amount       Decimal
  payment_date DateTime
  status       PaymentStatus

  vendor Vendor @relation(fields: [vendor_id], references: [id])
}

/// 배송
model Delivery {
  id               Int            @id @default(autoincrement())
  delivery_id      String         @unique                        // ERP용
  shipment_id      Int            @unique
  delivery_company String
  tracking_number  String
  delivered_date   DateTime
  status           DeliveryStatus

  shipment Shipment @relation(fields: [shipment_id], references: [id])
}

//
// ENUMS
//
enum InventoryStatus {
  NORMAL
  EXPIRING
  DISCARDED
}

enum OrderStatus {
  PENDING
  INPROGRESS
  CANCELED
  SHIPPING
  PARTIALLY
  COMPLETED
}

enum UseState {
  USED
  NOTUSED
}

enum DeliveryStatus {
  PENDING
  SHIPPING
  COMPLETED
}

enum HygieneGrade {
  A
  B
  C
}

enum PaymentStatus {
  PENDING
  COMPLETED
}

enum CategoryGroup {
  MEAT
  SEAFOOD
  NOODLES
  VEGETABLES
  DAIRY
  EGGS
  PROCESSED
  SAUCES
  SEASONINGS
  SOUPS
  BROTH_BASE
}

enum LotActionType {
  INBOUND   // 입고
  OUTBOUND  // 출고
}